variables:
  outputDirPath: "./build/sym"
  IPA_PATH: "${outputDirPath}/*.ipa"
  DSYM_PATH: "*.dSYM.zip"
  scheme: "Nextcloud"
  archive_path: "${outputDirPath}/${scheme}"
  exportOptionsPath: "./exportOptionsAdHoc.plist"


stages:
- build

.mac_general_scripts: &mac_general_scripts
  - brew install carthage
  - fastlane -v
  - xcodebuild -version
  - date

.install_carthage_dependencies: &install_carthage_dependencies
  - carthage update --use-xcframeworks --platform iOS

.download_google_info_plist: &download_google_info_plist
  - curl "https://raw.githubusercontent.com/firebase/quickstart-ios/main/mock-GoogleService-Info.plist" -o ./GoogleService-Info.plist

.build_general_script: &build_general_script
  - fastlane gym
    --scheme $scheme
    --output_directory $outputDirPath
    --derived_data_path ./ipaDerivedData
    --output_name $scheme
    --archive_path $archive_path
    --export_options $exportOptionsPath
    --silent
    --clean
    
.build_simulator_general_script: &build_simulator_general_script
  - xcodebuild -configuration Debug -scheme $scheme -sdk iphonesimulator -derivedDataPath ./BuildForSimulator -quiet

############## build ##############

.build_general_params: &build_general_params
  retry: 1
  stage: build
  tags:
    - xcode15
  before_script:
    - *mac_general_scripts
  artifacts:
    paths:
      - $IPA_PATH
      - $DSYM_PATH
    expire_in: 1 week

build_develop_feature:
  <<: *build_general_params
  script:
    - *install_carthage_dependencies
    - *build_general_script
  only:
    - develop
    - /^feature/

build_simulator:
  <<: *build_general_params
  when: manual
  script:
    - *install_carthage_dependencies
    - *download_google_info_plist
    - *build_simulator_general_script
    - zip -r ../../../../${scheme}.zip ${scheme}.app
  only:
    - develop
    - /^feature/
    - /^hotfix/
    - /^release/
  artifacts:
    paths:
      - Nextcloud.zip
    expire_in: 1 week
